<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>대화</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body class="chat-page">
    <header class="topbar">
      <div class="topbar-title">대화</div>
      <nav class="topbar-actions">
        <a class="link" href="{{ url_for('index', view='txt') }}">텍스트 형식</a>
        <a class="link" href="{{ url_for('admin_import') }}">가져오기</a>
        <a class="link" href="{{ url_for('logout') }}">로그아웃</a>
      </nav>
      <div class="topbar-tools">
        <form class="me-form" method="post" action="{{ url_for('set_me') }}">
          <label class="me-label">오른쪽(나)</label>
          <select class="select" name="me_name" onchange="this.form.submit()">
            <option value="">(선택)</option>
            {% for s in senders or [] %}
              <option value="{{ s.sender }}" {% if me_name == s.sender %}selected{% endif %}>{{ s.sender }} ({{ s.count }})</option>
            {% endfor %}
          </select>
        </form>
        <div class="jump">
          <label class="me-label">날짜 이동</label>
          <select class="select" id="jump-day">
            <option value="">(선택)</option>
            {% for d in days or [] %}
              <option value="day-{{ d.date_key }}">{{ d.date_ko }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </header>

    {% with flashes = get_flashed_messages(with_categories=true) %}
      {% if flashes %}
        <div class="flash chat-flash">
          {% for category, message in flashes %}
            <div class="flash-item {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <main class="chat" id="chat-scroll">
      {% for d in days or [] %}
        <div class="day-sep" id="day-{{ d.date_key }}">--------------- {{ d.date_ko }} ---------------</div>
        {% for m in d.messages %}
          {% set is_me = (me_name and m.sender == me_name) %}
          <div class="msg-row {{ 'me' if is_me else 'other' }}">
            {% if is_me %}
              <div class="time">{{ m.time_ko }}</div>
              <div class="bubble bubble-me">{{ m.text | e | replace('\n','<br>') | safe }}</div>
            {% else %}
              <div class="msg-col">
                <div class="sender">{{ m.sender }}</div>
                <div class="bubble bubble-other">{{ m.text | e | replace('\n','<br>') | safe }}</div>
              </div>
              <div class="time">{{ m.time_ko }}</div>
            {% endif %}
          </div>
        {% endfor %}
      {% endfor %}
    </main>

    <script>
      (function () {
        var sel = document.getElementById("jump-day");
        if (sel) {
          sel.addEventListener("change", function () {
            if (!sel.value) return;
            var el = document.getElementById(sel.value);
            if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
          });
        }
        var chat = document.getElementById("chat-scroll");
        if (chat && !location.hash) {
          chat.scrollTop = chat.scrollHeight;
        }
      })();
    </script>
  </body>
</html>
